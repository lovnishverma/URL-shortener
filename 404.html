<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Redirecting...</title>
</head>
<body>
  <p>Redirecting, please wait...</p>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // Firebase config (same as script.js)
    const firebaseConfig = {
      apiKey: "AIzaSyCE0ar8JMPjc9-LTKn8FSOBeriVsegtot4",
      authDomain: "urlshortner-3cbda.firebaseapp.com",
      projectId: "urlshortner-3cbda",
      storageBucket: "urlshortner-3cbda.appspot.com",
      messagingSenderId: "299618523499",
      appId: "1:299618523499:web:bae9a63eb704bbda20142e",
      measurementId: "G-3D652P2L90"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function redirect() {
      const path = window.location.pathname; 
      // extract short code (last segment)
      const shortCode = path.split('/').pop();

      if (!shortCode) return;

      try {
        const querySnapshot = await getDocs(collection(db, 'urls'));
        let found = false;

        querySnapshot.forEach(doc => {
          const data = doc.data();
          if (data.short.endsWith('/' + shortCode)) {
            found = true;
            window.location.href = data.original; // redirect to original URL
          }
        });

        if (!found) {
          document.body.innerHTML = "<p>URL not found. <a href='/URL-shortener/'>Go back</a></p>";
        }
      } catch (err) {
        console.error(err);
        document.body.innerHTML = "<p>Error loading URL. Please try again later.</p>";
      }
    }

    redirect();
  </script>
</body>
</html>
